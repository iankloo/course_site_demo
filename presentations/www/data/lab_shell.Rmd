---
title: "DOE Lab"
date: "November 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

An article in Biotechnology Progress (December 2002, Vol. 18(6), pp. 1170-1175) presented a \(\ 2^{7-3} \) fractional factorial design to evaluate factors promoting astaxanthin production. 

As described in Algal Research (Volume 18, September 2016, Pages 175-190), "astaxanthin is considered the most powerful antioxidant in nature, serving the role of a highly efficient scavenger of free radicals build up within the human body. Astaxanthin is a substance that protects the skin against UV-induced photo-oxidation and it is used for anti-tumor therapies and prevention - treatment of neural damage interrelated with age-related macular degeneration, Alzheimer and Parkinson diseases. Furthermore, it is considered as a natural superfood destined to enhance athletic performance by increasing stamina and reducing the time of muscle recovery." 

[source: https://www.sciencedirect.com/science/article/pii/S2211926416301965]

The data are from the fractional factorial experiment are shown in the following table.

```{r, echo=FALSE, fig.cap="**14-92 Data**", out.width = '70%'}
knitr::include_graphics("14_92_data.png")
```

The factors and levels in this experiment are shown here:

```{r, echo=FALSE, fig.cap="**14-92 Factors**", out.width = '40%'}
knitr::include_graphics("14_92_factors.png")
```

We would like to anaylze the results of this experiment, but we don't know which defining relations were used in the experimental design.  As a result, we also don't know which effects are aliased, which is needed in order to analyze the results of the experiment.

Make sure that interactionFunction.R is stored in the same folder as this file, then run the chunk below to generate the full design matrix.

```{r}
source(file = "interactionFunction.R")
TC <- treatmentCombos(vec = c("a", "b", "c", "d", "e", "f", "g"))
df <- buildTreatments(myFactors =  c("A", "B", "C", "D", "E", "F", "G"))
df <- makeInteractionGrid(myData = df)
```


If we assume that the principal fraction of the full design matrix was used to select the fractional factorial design, we can identify the effect contrast columns that are all positive, thereby identifying the complete defining relation.  With the complete defining relation, we can then identify the alias structure.

Create a character vector of the treatment combinations at which observations were made in the experiment.  For instance, the first treatment combination is "def".  Then use the match() function to return the index of all rows of the complete design matrix for these treatment combinations.

```{r}
tcs <- c("def",     ) # add the remaining treatment combinations
design_tcs <- match(tcs, df$treatment) # this returns the row numbers of the TCs
```


Now identify the columns that are all +1's for the rows identified above, since these will be our complete defining relation.

```{r}
z <- list() # create an empty list to fill in the loop below
# The loop below returns the column name (effect) for all columns that are all +1s for the subsetted design matrix
for (i in seq_along(2:length(colnames(df)))) {
z[i-1] <-  ifelse(identical(df[ design_tcs , i ] , rep(1, 2^(7-3))), colnames(df[i]), NA)
}
def_rel <- unlist(z[!is.na(z)])
def_rel
```

### (a) Using the defining relations, identify the alias structure for all main and two-factor effects. (No need to include terms beyond two-factor interaction effects).
  



Now subset the full design matrix by the observed treatment combinations and add in columns for the two response variables observed in the experiment.
```{r}
df1 <- df[ design_tcs , c(1:8)]
df1$weight <- c(4.2,4.4,7.8,14.9,25.3,26.7,23.9,21.9,24.3,20.5,10.8,20.8,13.5,10.3,23,12.1)
df1$cellular <- c(10.8,24.9,27.3,36.3,112.6,159.3,145.2,234.2,72.1,112.2,22.5,149.7,140.1,47.3,153.2,35.2)
df1
```


###(b) Estimate the main and two-factor interaction effects using regression. Recall that there are two response variables (you need two models)
```{r}
# Regression models and output

```

```{r}
# Magnitude of effects and aliases on weight:
effects1 <- 
```

```{r}
# Magnitude of effects and aliases on cellular content:
effects2 <- 
```


###(c) Plot the effect estimates on a normal probability scale and interpret the results.
```{r}
df1 <- qqnorm(effects1, ylim = c(-10,15))
qqline( effects1 )
text( df1$x, df1$y, names(effects1), pos=1 )


df1 <- qqnorm(effects2, ylim = c(-40,70))
qqline( effects2 )
text( df1$x, df1$y, names(effects2), pos=1 )

```

